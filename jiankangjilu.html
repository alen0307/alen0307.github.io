<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>å¥åº·è®°å½•å™¨Â·ç‚¹å‡»ä¿®å¤æœ€ç»ˆç‰ˆ</title>
<style>
/* ä¸ä¸Šä¸€ç‰ˆæ ·å¼ç›¸åŒï¼Œä»…æ–°å¢ .click-mask */
*{box-sizing:border-box;margin:0;padding:0}
body{font:13px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft YaHei",sans-serif;background:linear-gradient(135deg,#e0f7fa 0%,#bbdefb 100%);color:#2c3e50;padding:8px}
.container{max-width:900px;margin:0 auto;background:rgba(255,255,255,.85);border-radius:8px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.header{padding:12px 16px;background:linear-gradient(135deg,#43cea2 0%,#185a9d 100%);color:#fff}.header h1{font-size:18px;margin-bottom:4px}
.nav-buttons{display:flex;gap:6px;flex-wrap:wrap}.nav-btn{padding:6px 10px;border:0;border-radius:4px;font-size:12px;color:#fff;cursor:pointer;transition:all .2s}
.nav-btn.food{background:#ff9a9e}.nav-btn.sleep{background:#a1c4fd}.nav-btn.exercise{background:#ffecd2;color:#333}.nav-btn.body{background:#84fab0}.nav-btn.active{transform:scale(.95);opacity:.9}
.content{padding:10px}.form-section{display:none}.form-section.active{display:block}
.form-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}.form-row .form-group{flex:1;min-width:140px}
label{font-size:12px;font-weight:600;margin-bottom:3px;display:block}input,select,textarea{width:100%;padding:5px 6px;border:1px solid #cfd8dc;border-radius:4px;font-size:12px}
input:focus,select:focus,textarea:focus{border-color:#43cea2;outline:0}textarea{resize:vertical;min-height:40px}
.btn-save{margin:8px auto 0;display:block;padding:6px 14px;border:0;border-radius:4px;font-size:12px;font-weight:600;color:#fff;background:linear-gradient(135deg,#43cea2 0%,#185a9d 100%);cursor:pointer}
.records-section{margin-top:10px;border-top:1px solid rgba(0,0,0,.05);padding-top:8px}
.records-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;position:relative}
.btn-import,.btn-export{padding:4px 8px;border:0;border-radius:3px;font-size:11px;color:#fff;cursor:pointer}.btn-import{background:#5d69be}.btn-export{background:#ff9a9e}
.records-list{display:grid;gap:6px}.record-item{padding:8px;border-radius:4px;border-left:3px solid;background:rgba(255,255,255,.7);cursor:pointer;position:relative}
.record-item.food{border-left-color:#ff9a9e}.record-item.sleep{border-left-color:#a1c4fd}.record-item.exercise{border-left-color:#ffecd2}.record-item.body{border-left-color:#84fab0}
.record-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;font-size:12px;position:relative}
.click-mask{position:absolute;inset:0;z-index:1;cursor:pointer}
.record-type{font-weight:600;position:relative;z-index:2}.record-time{color:#7f8c8d;font-size:11px;position:relative;z-index:2}
.record-details{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:4px;font-size:11px}.record-detail{background:rgba(255,255,255,.6);padding:3px 5px;border-radius:3px}
.record-note{font-size:11px;margin-top:4px;padding:3px 5px;background:rgba(255,255,255,.6);border-radius:3px;font-style:italic}
.delete-btn{position:absolute;top:4px;right:4px;padding:2px 6px;font-size:10px;border:0;border-radius:3px;background:#ff6b6b;color:#fff;cursor:pointer;line-height:1;z-index:2}
.edit-form{display:none;margin-top:6px}.edit-form.active{display:block}.edit-form input,.edit-form select,.edit-form textarea{font-size:11px;padding:3px 4px}
.edit-actions{display:flex;gap:6px;margin-top:6px}.edit-actions button{flex:1;padding:4px;border:0;border-radius:3px;font-size:11px;cursor:pointer}.edit-actions .save{background:#43cea2;color:#fff}.edit-actions .cancel{background:#b0b0b0;color:#fff}
.file-input{display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:999;display:none}.modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:16px;border-radius:6px;width:90%;max-width:300px;text-align:center;font-size:13px}.modal-buttons{display:flex;gap:8px;margin-top:10px}.modal-buttons button{flex:1;padding:6px;border:0;border-radius:3px;font-size:12px;cursor:pointer}.modal-buttons .confirm{background:#43cea2;color:#fff}.modal-buttons .cancel{background:#b0b0b0;color:#fff}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ¥ å¥åº·è®°å½•å™¨ï¼ˆç‚¹å‡»ä¿®å¤æœ€ç»ˆç‰ˆï¼‰</h1>
    <div class="nav-buttons">
      <button class="nav-btn food active" onclick="showSec('food')">ğŸ é¥®é£Ÿ</button>
      <button class="nav-btn sleep" onclick="showSec('sleep')">ğŸ˜´ ç¡çœ </button>
      <button class="nav-btn exercise" onclick="showSec('exercise')">ğŸƒ è¿åŠ¨</button>
      <button class="nav-btn body" onclick="showSec('body')">ğŸ«€ èº«ä½“</button>
    </div>
  </div>

  <div class="content">
    <!-- é¥®é£Ÿ -->
    <div id="food-sec" class="form-section active">
      <div class="form-row">
        <div class="form-group"><label>è¿›é£Ÿæ—¶é—´</label><input type="datetime-local" id="food-time" required></div>
        <div class="form-group"><label>é£Ÿç‰©ç±»å‹</label>
          <select id="food-type" required><option value="">é€‰ç±»å‹</option><option>ä¸»é£Ÿ</option><option>è”¬èœ</option><option>æ°´æœ</option><option>è‚‰ç±»</option><option>ä¹³åˆ¶å“</option><option>é›¶é£Ÿ</option><option>é¥®æ–™</option><option>å…¶ä»–</option></select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>åˆ†é‡</label><input id="food-amount" placeholder="ä¾‹ï¼šä¸€ç¢—ç±³é¥­" required></div>
        <div class="form-group"><label>èº«ä½“æ„Ÿè§‰</label>
          <select id="food-feeling" required><option value="">é€‰æ„Ÿè§‰</option><option>å¾ˆå¥½</option><option>è‰¯å¥½</option><option>ä¸€èˆ¬</option><option>ä¸é€‚</option><option>å¾ˆä¸èˆ’æœ</option></select>
        </div>
      </div>
      <div class="form-group"><label>å¤‡æ³¨</label><textarea id="food-note" rows="2"></textarea></div>
      <button class="btn-save" onclick="saveRec('food')">ä¿å­˜é¥®é£Ÿ</button>
    </div>

    <!-- ç¡çœ  -->
    <div id="sleep-sec" class="form-section">
      <div class="form-row">
        <div class="form-group"><label>å…¥ç¡æ—¶é—´</label><input type="datetime-local" id="sleep-time" onchange="calcSlDur()"></div>
        <div class="form-group"><label>é†’æ¥æ—¶é—´</label><input type="datetime-local" id="wake-time" onchange="calcSlDur()"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>ç¡çœ æ—¶é•¿(h)</label><input id="sleep-duration" readonly></div>
        <div class="form-group"><label>ç¡çœ è´¨é‡</label>
          <select id="sleep-quality"><option value="">é€‰è´¨é‡</option><option>å¾ˆå¥½</option><option>è‰¯å¥½</option><option>ä¸€èˆ¬</option><option>è¾ƒå·®</option><option>å¾ˆå·®</option></select>
        </div>
      </div>
      <div class="form-group"><label>å¤‡æ³¨</label><textarea id="sleep-note" rows="2"></textarea></div>
      <button class="btn-save" onclick="saveRec('sleep')">ä¿å­˜ç¡çœ </button>
    </div>

    <!-- è¿åŠ¨ -->
    <div id="exercise-sec" class="form-section">
      <div class="form-row">
        <div class="form-group"><label>è¿åŠ¨æ—¶é—´</label><input type="datetime-local" id="exercise-time"></div>
        <div class="form-group"><label>æ—¶é•¿(min)</label><input type="number" id="exercise-duration" min="0" max="1440"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>è¿åŠ¨ç±»å‹</label>
          <select id="exercise-type"><option value="">é€‰ç±»å‹</option><option>è·‘æ­¥</option><option>æ•£æ­¥</option><option>æ¸¸æ³³</option><option>éª‘è¡Œ</option><option>å¥èº«</option><option>ç‘œä¼½</option><option>çƒç±»è¿åŠ¨</option><option>å…¶ä»–</option></select>
        </div>
        <div class="form-group"><label>å¼ºåº¦</label>
          <select id="exercise-intensity"><option value="">é€‰å¼ºåº¦</option><option>ä½å¼ºåº¦</option><option>ä¸­ç­‰å¼ºåº¦</option><option>é«˜å¼ºåº¦</option><option>æé«˜å¼ºåº¦</option></select>
        </div>
      </div>
      <div class="form-group"><label>æ­¥æ•°ï¼ˆå¯é€‰ï¼‰</label><input type="number" id="exercise-steps" min="0" placeholder="æ­¥æ•°"></div>
      <div class="form-group"><label>å¤‡æ³¨</label><textarea id="exercise-note" rows="2"></textarea></div>
      <button class="btn-save" onclick="saveRec('exercise')">ä¿å­˜è¿åŠ¨</button>
    </div>

    <!-- èº«ä½“ -->
    <div id="body-sec" class="form-section">
      <div class="score-container" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:8px;font-size:12px">
        <div class="score-item"><label>å¤´éƒ¨0-10</label><input type="range" id="head-score" min="0" max="10" value="8" oninput="upScore('head')"><div id="head-display">8åˆ†</div></div>
        <div class="score-item"><label>èƒ¸éƒ¨0-10</label><input type="range" id="chest-score" min="0" max="10" value="8" oninput="upScore('chest')"><div id="chest-display">8åˆ†</div></div>
        <div class="score-item"><label>è…¹éƒ¨0-10</label><input type="range" id="abdomen-score" min="0" max="10" value="8" oninput="upScore('abdomen')"><div id="abdomen-display">8åˆ†</div></div>
        <div class="score-item"><label>å››è‚¢0-10</label><input type="range" id="limbs-score" min="0" max="10" value="8" oninput="upScore('limbs')"><div id="limbs-display">8åˆ†</div></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>è®°å½•æ—¶é—´</label><input type="datetime-local" id="body-time"></div>
        <div class="form-group"><label>æ€»ä½“è¯„åˆ†</label><input id="body-total" readonly></div>
      </div>
      <div class="form-group"><label>å¤‡æ³¨</label><textarea id="body-note" rows="2"></textarea></div>
      <button class="btn-save" onclick="saveRec('body')">ä¿å­˜çŠ¶æ€</button>
    </div>

    <!-- è®°å½•åˆ—è¡¨ -->
    <div class="records-section">
      <div class="records-header">
        <div style="font-size:13px;font-weight:600">ğŸ“‹ å†å²è®°å½•</div>
        <div class="btn-group"><button class="btn-import" onclick="importData()">ğŸ“¥ å¯¼å…¥</button><button class="btn-export" onclick="exportData()">ğŸ“¤ å¯¼å‡º</button></div>
      </div>
      <input type="file" id="file-input" class="file-input" accept=".json" onchange="handleFileImport(event)">
      <div id="records-list" class="records-list"></div>
    </div>
  </div>
</div>

<!-- ç¡®è®¤æ¨¡æ€ -->
<div id="confirm-modal" class="modal"><div class="modal-content"><div id="confirm-message"></div><div class="modal-buttons"><button class="confirm" onclick="confirmYes()">ç¡®å®š</button><button class="cancel" onclick="closeModal()">å–æ¶ˆ</button></div></div></div>

<script>
/* ===== å·¥å…· ===== */
const $=id=>document.getElementById(id);
const fmtDate=d=>new Date(d).toLocaleString('zh-CN');
const msg=txt=>{
  const m=document.createElement('div');m.style.cssText='position:fixed;top:10px;right:10px;background:#43cea2;color:#fff;padding:6px 10px;border-radius:4px;font-size:12px;z-index:2000';
  m.textContent=txt;document.body.appendChild(m);setTimeout(()=>m.remove(),1500);
};
/* ===== æ—¶åŒº ===== */
const tz8=d=>new Date(d.getTime()+8*3600e3).toISOString().slice(0,16);
const now8=()=>tz8(new Date);

/* ===== æ•°æ® ===== */
let records=JSON.parse(localStorage.getItem('healthRecords')||'[]');
let curSec='food';
let confirmCb=null;

/* ===== å¯¼èˆª ===== */
function showSec(sec){
  document.querySelectorAll('.form-section').forEach(s=>s.classList.remove('active'));
  $(sec+'-sec').classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.nav-btn.'+sec).classList.add('active');
  curSec=sec;
}

/* ===== è¯„åˆ† ===== */
function upScore(p){
  const v=$(p+'-score').value,d=$(p+'-display');
  d.textContent=v+'åˆ†';
  if(v<=3)d.style.color='#e74c3c';else if(v>=8)d.style.color='#27ae60';else d.style.color='#f39c12';
  calcTotal();
}
function calcTotal(){
  const avg=(['head','chest','abdomen','limbs'].reduce((s,p)=>s+parseInt($(p+'-score').value),0)/4).toFixed(1);
  $('body-total').value=avg+'åˆ†';
}
function calcSlDur(){
  const s=$('sleep-time').value,w=$('wake-time').value;
  if(s&&w&&new Date(w)>new Date(s)){
    const dr=((new Date(w)-new Date(s))/3600000).toFixed(1);
    $('sleep-duration').value=dr;
  }
}

/* ===== ä¿å­˜æ–°è®°å½• ===== */
function saveRec(type){
  try{
    const rec={id:Date.now(),type,timestamp:new Date().toISOString()};
    switch(type){
      case 'food':Object.assign(rec,{time:$('food-time').value,foodType:$('food-type').value,amount:$('food-amount').value,feeling:$('food-feeling').value,note:$('food-note').value});break;
      case 'sleep':Object.assign(rec,{sleepTime:$('sleep-time').value,wakeTime:$('wake-time').value,duration:parseFloat($('sleep-duration').value),quality:$('sleep-quality').value,note:$('sleep-note').value});break;
      case 'exercise':Object.assign(rec,{time:$('exercise-time').value,duration:parseInt($('exercise-duration').value),exerciseType:$('exercise-type').value,intensity:$('exercise-intensity').value,steps:parseInt($('exercise-steps').value)||0,note:$('exercise-note').value});break;
      case 'body':Object.assign(rec,{time:$('body-time').value,headScore:parseInt($('head-score').value),chestScore:parseInt($('chest-score').value),abdomenScore:parseInt($('abdomen-score').value),limbsScore:parseInt($('limbs-score').value),totalScore:parseFloat($('body-total').value),note:$('body-note').value});break;
    }
    if(!(rec.time || (rec.sleepTime && rec.wakeTime))) throw new Error('æ—¶é—´å¿…å¡«');
    records.unshift(rec);localStorage.setItem('healthRecords',JSON.stringify(records));
    msg('å·²ä¿å­˜');showList();resetForm(type);
  }catch(e){alert(e.message)}
}
function resetForm(type){
  switch(type){
    case 'food':$('food-type').value='';$('food-amount').value='';$('food-feeling').value='';$('food-note').value='';break;
    case 'sleep':$('sleep-quality').value='';$('sleep-note').value='';break;
    case 'exercise':$('exercise-duration').value='';$('exercise-type').value='';$('exercise-intensity').value='';$('exercise-steps').value='';$('exercise-note').value='';break;
    case 'body':['head','chest','abdomen','limbs'].forEach(p=>$(p+'-score').value=8);calcTotal();break;
  }
  setDefTime();
}
function setDefTime(){
  ['food-time','sleep-time','exercise-time','body-time'].forEach(id=>{if($(id))$(id).value=now8();});
  if($('sleep-time'))$('sleep-time').value=now8();
  if($('wake-time'))$('wake-time').value=now8();
}

/* ===== åˆ—è¡¨ / ç¼–è¾‘ ===== */
function showList(){
  const lst=$('records-list');
  if(!records.length){lst.innerHTML='<div style="text-align:center;color:#999;padding:10px;font-size:12px">æš‚æ— è®°å½•</div>';return}
  lst.innerHTML='';
  records.forEach(r=>{
    const div=document.createElement('div');div.className=`record-item ${r.type}`;
    div.innerHTML=renderItem(r)+renderEditForm(r);
    lst.appendChild(div);
  });
}
function renderItem(r){
  let det='',icon='';
  switch(r.type){
    case 'food':icon='ğŸ';det=`<div class="record-detail">â° ${r.time}</div><div class="record-detail">ğŸ¥— ${r.foodType}</div><div class="record-detail">âš–ï¸ ${r.amount}</div><div class="record-detail">ğŸ˜Š ${r.feeling}</div>`;break;
    case 'sleep':icon='ğŸ˜´';det=`<div class="record-detail">ğŸŒ™ ${r.sleepTime}</div><div class="record-detail">â˜€ï¸ ${r.wakeTime}</div><div class="record-detail">â±ï¸ ${r.duration}h</div><div class="record-detail">â­ ${r.quality}</div>`;break;
    case 'exercise':icon='ğŸƒ';det=`<div class="record-detail">â° ${r.time}</div><div class="record-detail">â±ï¸ ${r.duration}min</div><div class="record-detail">ğŸƒ ${r.exerciseType}</div><div class="record-detail">ğŸ’ª ${r.intensity}</div>`;if(r.steps)det+=`<div class="record-detail">ğŸ‘Ÿ ${r.steps}æ­¥</div>`;break;
    case 'body':icon='ğŸ«€';det=`<div class="record-detail">ğŸ§  ${r.headScore}</div><div class="record-detail">ğŸ’“ ${r.chestScore}</div><div class="record-detail">ğŸ«ƒ ${r.abdomenScore}</div><div class="record-detail">ğŸ¦µ ${r.limbsScore}</div><div class="record-detail">ğŸ“Š ${r.totalScore}</div>`;break;
  }
  return `<div class="record-header">
            <div class="click-mask" onclick="toggleEdit(${r.id})"></div>
            <span class="record-type">${icon} ${{food:'é¥®é£Ÿ',sleep:'ç¡çœ ',exercise:'è¿åŠ¨',body:'èº«ä½“'}[r.type]}</span>
            <span class="record-time">${fmtDate(r.timestamp)}</span>
          </div>
          <div class="record-details">${det}</div>${r.note?`<div class="record-note">ğŸ“ ${r.note}</div>`:''}
          <button class="delete-btn" onclick="confirmDel(${r.id})">åˆ é™¤</button>`;
}
function renderEditForm(r){
  const fid=`edit-${r.id}`;
  let html=`<div id="${fid}" class="edit-form">`;  <!-- ä¸å†åŠ  stopPropagation -->
  switch(r.type){
    case 'food':html+=`
      <div class="form-row">
        <div class="form-group"><label>è¿›é£Ÿæ—¶é—´</label><input type="datetime-local" id="${fid}-time" value="${r.time}"></div>
        <div class="form-group"><label>é£Ÿç‰©ç±»å‹</label><select id="${fid}-foodType"><option>${r.foodType}</option><option>ä¸»é£Ÿ</option><option>è”¬èœ</option><option>æ°´æœ</option><option>è‚‰ç±»</option><option>ä¹³åˆ¶å“</option><option>é›¶é£Ÿ</option><option>é¥®æ–™</option><option>å…¶ä»–</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>åˆ†é‡</label><input id="${fid}-amount" value="${r.amount}"></div>
        <div class="form-group"><label>èº«ä½“æ„Ÿè§‰</label><select id="${fid}-feeling"><option>${r.feeling}</option><option>å¾ˆå¥½</option><option>è‰¯å¥½</option><option>ä¸€èˆ¬</option><option>ä¸é€‚</option><option>å¾ˆä¸èˆ’æœ</option></select></div>
      </div>
      <div class="form-group"><label>å¤‡æ³¨</label><textarea id="${fid}-note" rows="2">${r.note||''}</textarea></div>`;break;
    case 'sleep':html+=`
      <div class="form-row">
        <div class="form-group"><label>å…¥ç¡</label><input type="datetime-local" id="${fid}-sleepTime" value="${r.sleepTime}"></div>
        <div class="form-group"><label>é†’æ¥</label><input type="datetime-local" id="${fid}-wakeTime" value="${r.wakeTime}"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>æ—¶é•¿(h)</label><input id="${fid}-duration" type="number" step="0.1" value="${r.duration}"></div>
        <div class="form-group"><label>è´¨é‡</label><select id="${fid}-quality"><option>${r.quality}</option><option>å¾ˆå¥½</option><option>è‰¯å¥½</option><option>ä¸€èˆ¬</option><option>è¾ƒå·®</option><option>å¾ˆå·®</option></select></div>
      </div>
      <div class="form-group"><label>å¤‡æ³¨</label><textarea id="${fid}-note" rows="2">${r.note||''}</textarea></div>`;break;
    case 'exercise':html+=`
      <div class="form-row">
        <div class="form-group"><label>è¿åŠ¨æ—¶é—´</label><input type="datetime-local" id="${fid}-time" value="${r.time}"></div>
        <div class="form-group"><label>æ—¶é•¿(min)</label><input type="number" id="${fid}-duration" min="0" value="${r.duration}"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>ç±»å‹</label><select id="${fid}-exerciseType"><option>${r.exerciseType}</option><option>è·‘æ­¥</option><option>æ•£æ­¥</option><option>æ¸¸æ³³</option><option>éª‘è¡Œ</option><option>å¥èº«</option><option>ç‘œä¼½</option><option>çƒç±»è¿åŠ¨</option><option>å…¶ä»–</option></select></div>
        <div class="form-group"><label>å¼ºåº¦</label><select id="${fid}-intensity"><option>${r.intensity}</option><option>ä½å¼ºåº¦</option><option>ä¸­ç­‰å¼ºåº¦</option><option>é«˜å¼ºåº¦</option><option>æé«˜å¼ºåº¦</option></select></div>
      </div>
      <div class="form-group"><label>æ­¥æ•°</label><input type="number" id="${fid}-steps" min="0" value="${r.steps}"></div>
      <div class="form-group"><label>å¤‡æ³¨</label><textarea id="${fid}-note" rows="2">${r.note||''}</textarea></div>`;break;
    case 'body':html+=`
      <div class="score-container" style="grid-template-columns:repeat(2,1fr);gap:6px;font-size:11px">
        <div class="score-item"><label>å¤´éƒ¨</label><input type="range" id="${fid}-headScore" min="0" max="10" value="${r.headScore}" oninput="upEditScore('${fid}','headScore')"><div id="${fid}-headScore-display">${r.headScore}åˆ†</div></div>
        <div class="score-item"><label>èƒ¸éƒ¨</label><input type="range" id="${fid}-chestScore" min="0" max="10" value="${r.chestScore}" oninput="upEditScore('${fid}','chestScore')"><div id="${fid}-chestScore-display">${r.chestScore}åˆ†</div></div>
        <div class="score-item"><label>è…¹éƒ¨</label><input type="range" id="${fid}-abdomenScore" min="0" max="10" value="${r.abdomenScore}" oninput="upEditScore('${fid}','abdomenScore')"><div id="${fid}-abdomenScore-display">${r.abdomenScore}åˆ†</div></div>
        <div class="score-item"><label>å››è‚¢</label><input type="range" id="${fid}-limbsScore" min="0" max="10" value="${r.limbsScore}" oninput="upEditScore('${fid}','limbsScore')"><div id="${fid}-limbsScore-display">${r.limbsScore}åˆ†</div></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>è®°å½•æ—¶é—´</label><input type="datetime-local" id="${fid}-time" value="${r.time}"></div>
        <div class="form-group"><label>æ€»ä½“</label><input id="${fid}-total" readonly value="${r.totalScore}"></div>
      </div>
      <div class="form-group"><label>å¤‡æ³¨</label><textarea id="${fid}-note" rows="2">${r.note||''}</textarea></div>`;break;
  }
  html+=`<div class="edit-actions"><button class="save" onclick="saveEdit(${r.id})">ä¿å­˜</button><button class="cancel" onclick="cancelEdit(${r.id})">å–æ¶ˆ</button></div></div>`;
  return html;
}

// æ·»åŠ è¿™ä¸ªå‡½æ•°æ¥åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
function toggleEdit(id) {
    const editForm = $(`edit-${id}`);
    if (editForm.classList.contains('active')) {
        // å¦‚æœç¼–è¾‘è¡¨å•å½“å‰æ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
        editForm.classList.remove('active');
    } else {
        // å¦‚æœç¼–è¾‘è¡¨å•å½“å‰æ˜¯éšè—çš„ï¼Œåˆ™éšè—æ‰€æœ‰å…¶ä»–ç¼–è¾‘è¡¨å•ï¼Œç„¶åæ˜¾ç¤ºè¿™ä¸ª
        document.querySelectorAll('.edit-form').forEach(form => form.classList.remove('active'));
        editForm.classList.add('active');
    }
}
function saveEdit(id){
  const idx=records.findIndex(r=>r.id===id);
  if(idx===-1)return;
  const r=records[idx],fid=`edit-${id}`;
  switch(r.type){
    case 'food':Object.assign(r,{time:$(fid+'-time').value,foodType:$(fid+'-foodType').value,amount:$(fid+'-amount').value,feeling:$(fid+'-feeling').value,note:$(fid+'-note').value});break;
    case 'sleep':Object.assign(r,{sleepTime:$(fid+'-sleepTime').value,wakeTime:$(fid+'-wakeTime').value,duration:parseFloat($(fid+'-duration').value),quality:$(fid+'-quality').value,note:$(fid+'-note').value});break;
    case 'exercise':Object.assign(r,{time:$(fid+'-time').value,duration:parseInt($(fid+'-duration').value),exerciseType:$(fid+'-exerciseType').value,intensity:$(fid+'-intensity').value,steps:parseInt($(fid+'-steps').value)||0,note:$(fid+'-note').value});break;
    case 'body':Object.assign(r,{time:$(fid+'-time').value,headScore:parseInt($(fid+'-headScore').value),chestScore:parseInt($(fid+'-chestScore').value),abdomenScore:parseInt($(fid+'-abdomenScore').value),limbsScore:parseInt($(fid+'-limbsScore').value),totalScore:parseFloat($(fid+'-total').value),note:$(fid+'-note').value});break;
  }
  r.timestamp=new Date().toISOString();
  localStorage.setItem('healthRecords',JSON.stringify(records));
  msg('å·²æ›´æ–°');showList();
}
function cancelEdit(id){$(`edit-${id}`).classList.remove('active');}
function upEditScore(fid,p){
  const v=$(fid+'-'+p).value,d=$(fid+'-'+p+'-display');
  d.textContent=v+'åˆ†';
  const avg=(['headScore','chestScore','abdomenScore','limbsScore'].reduce((s,x)=>s+parseInt($(fid+'-'+x).value),0)/4).toFixed(1);
  $(fid+'-total').value=avg+'åˆ†';
}

/* ===== åˆ é™¤ / ç¡®è®¤ ===== */
function confirmDel(id){
  showConfirm('ç¡®å®šåˆ é™¤ï¼Ÿ',()=>{records=records.filter(r=>r.id!==id);localStorage.setItem('healthRecords',JSON.stringify(records));msg('å·²åˆ é™¤');showList();});
}
function showConfirm(msg,cb){$('confirm-message').textContent=msg;$('confirm-modal').style.display='block';confirmCb=cb;}
function confirmYes(){if(confirmCb)confirmCb();closeModal();}
function closeModal(){$('confirm-modal').style.display='none';confirmCb=null;}

/* ===== å¯¼å…¥/å¯¼å‡º ===== */
function exportData(){
  if(!records.length){alert('æ— æ•°æ®');return;}
  const blob=new Blob([JSON.stringify(records,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`å¥åº·è®°å½•_${new Date().toLocaleDateString('zh-CN')}.json`;a.click();msg('å·²å¯¼å‡º');
}
function importData(){$('file-input').click();}
function handleFileImport(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    try{
      const data=JSON.parse(ev.target.result);
      if(!Array.isArray(data))throw 0;
      const existIds=new Set(records.map(r=>r.id));
      const merged=data.filter(r=>r.id&&!existIds.has(r.id));
      records.unshift(...merged);
      localStorage.setItem('healthRecords',JSON.stringify(records));
      msg(`æˆåŠŸåˆå¹¶ ${merged.length} æ¡è®°å½•`);showList();
    }catch{alert('æ–‡ä»¶æ ¼å¼é”™è¯¯')}
  };
  reader.readAsText(file);
  e.target.value='';
}

/* ===== åˆå§‹åŒ– ===== */
document.addEventListener('DOMContentLoaded',()=>{
  setDefTime();showList();['head','chest','abdomen','limbs'].forEach(p=>upScore(p));
});
</script>
</body>
</html>